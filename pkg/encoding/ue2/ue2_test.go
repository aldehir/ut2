package ue2

import (
	"bytes"
	"testing"

	"github.com/google/go-cmp/cmp"
)

type TestStruct struct {
	A int32
	B int32
	C Index
	D [3]byte
	E Index
	F Index
	G Index
	H Index

	Name string
}

func TestDecode(t *testing.T) {
	data := []byte{
		0xf6, 0xff, 0xff, 0xff,
		0x0a, 0x00, 0x00, 0x00,
		0x01,
		0x02, 0x03, 0x04,
		0x40 | 0x01, 0x02,
		0x40 | 0x01, 0x80 | 0x02, 0x03,
		0x40 | 0x01, 0x80 | 0x02, 0x80 | 0x03, 0x04,
		0x80 | 0x01,
		0x05, 'T', 'E', 'S', 'T', 0x00,
	}

	buf := bytes.NewBuffer(data)

	var got TestStruct
	err := Decode(buf, &got)
	if err != nil {
		t.Error(err)
	}

	want := TestStruct{
		A:    -10,
		B:    10,
		C:    1,
		D:    [3]byte{0x02, 0x03, 0x04},
		E:    0x02<<6 | 0x01,
		F:    0x03<<13 | 0x02<<6 | 0x01,
		G:    0x04<<20 | 0x03<<13 | 0x02<<6 | 0x01,
		H:    -1,
		Name: "TEST",
	}

	if d := cmp.Diff(want, got); d != "" {
		t.Errorf("TestDecode mismatch (-want,+got):\n%s", d)
	}
}

func TestEncode(t *testing.T) {
	obj := TestStruct{
		A:    -10,
		B:    10,
		C:    1,
		D:    [3]byte{0x02, 0x03, 0x04},
		E:    0x02<<6 | 0x01,
		F:    0x03<<13 | 0x02<<6 | 0x01,
		G:    0x04<<20 | 0x03<<13 | 0x02<<6 | 0x01,
		H:    -1,
		Name: "TEST",
	}

	buf := new(bytes.Buffer)

	want := []byte{
		0xf6, 0xff, 0xff, 0xff,
		0x0a, 0x00, 0x00, 0x00,
		0x01,
		0x02, 0x03, 0x04,
		0x40 | 0x01, 0x02,
		0x40 | 0x01, 0x80 | 0x02, 0x03,
		0x40 | 0x01, 0x80 | 0x02, 0x80 | 0x03, 0x04,
		0x80 | 0x01,
		0x05, 'T', 'E', 'S', 'T', 0x00,
	}

	err := Encode(buf, obj)
	if err != nil {
		t.Error(err)
	}

	got := buf.Bytes()

	if d := cmp.Diff(want, got); d != "" {
		t.Errorf("TestEncode mismatch (-want,+got):\n%s", d)
	}
}
